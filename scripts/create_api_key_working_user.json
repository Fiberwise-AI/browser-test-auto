{
  "script_name": "create_api_key_working_user",
  "description": "Create API key for a known working user",
  "version": "1.0",
  "settings": {
    "headless": false,
    "use_temp_instance": true,
    "video_recording": false,
    "take_screenshots": true,
    "auto_cleanup": false
  },
  "steps": [
    {
      "id": "setup",
      "type": "instance",
      "action": "create_temp_instance",
      "description": "Create and start temp FiberWise instance"
    },
    {
      "id": "register_user",
      "type": "browser",
      "action": "register_multiple_users",
      "description": "Register test user for API key creation",
      "config": {
        "headless": true,
        "users": [
          {
            "username": "keyuser",
            "email": "key@example.com",
            "password": "TestPass123!"
          }
        ]
      }
    },
    {
      "id": "db_check_users",
      "type": "command",
      "action": "verify_database",
      "description": "Check what users exist in the database",
      "config": {
        "queries": [
          "SELECT id, username, email, is_active, created_at FROM users ORDER BY created_at DESC LIMIT 10;",
          "SELECT COUNT(*) as user_count FROM users;",
          "SELECT id, name, user_id, created_at FROM api_keys ORDER BY created_at DESC LIMIT 5;"
        ],
        "database_path": "{{instance_dir}}/local_data/fiberwise.db"
      }
    },
    {
      "id": "login_existing_user",
      "type": "browser",
      "action": "test_login", 
      "description": "Login with existing user",
      "config": {
        "username": "keyuser",
        "password": "TestPass123!",
        "keep_page_open": true,
        "take_screenshot": true
      }
    },
    {
      "id": "create_api_key",
      "type": "api_key",
      "action": "create_api_key",
      "description": "Create a single API key",
      "config": {
        "username": "keyuser",
        "password": "TestPass123!",
        "key_name": "Test API Key",
        "scopes": ["read:all", "write:all"],
        "keep_page_open": true,
        "take_screenshot": true
      }
    },
    {
      "id": "wait_for_db_update",
      "type": "command",
      "action": "run_command",
      "description": "Wait for database to update after API key creation",
      "config": {
        "command": "timeout /t 3",
        "timeout": 5,
        "capture_output": false
      }
    },
    {
      "id": "verify_api_key",
      "type": "api_key",
      "action": "list_api_keys",
      "description": "List API keys to verify creation",
      "config": {
        "username": "keyuser",
        "password": "TestPass123!",
        "keep_page_open": true,
        "take_screenshot": true
      }
    },
    {
      "id": "db_check_final",
      "type": "command",
      "action": "verify_database",
      "description": "Final database check to verify API key creation",
      "config": {
        "queries": [
          "SELECT id, name, user_id, created_at FROM api_keys ORDER BY created_at DESC;",
          "SELECT COUNT(*) as api_key_count FROM api_keys;",
          "SELECT u.username, u.email, COUNT(k.id) as key_count FROM users u LEFT JOIN api_keys k ON u.id = k.user_id GROUP BY u.id;"
        ],
        "database_path": "{{instance_dir}}/local_data/fiberwise.db"
      }
    }
  ]
}
